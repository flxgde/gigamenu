@if (service.isOpen()) {
<div
  class="fixed inset-0 z-50 flex items-start justify-center pt-[15vh]"
  (click)="onBackdropClick($event)"
>
  <div class="fixed inset-0 bg-black/50 backdrop-blur-sm"></div>

  <!-- Custom panel template -->
  @if (panelTemplate(); as pt) {
    <ng-container
      [ngTemplateOutlet]="pt.template"
      [ngTemplateOutletContext]="getPanelContext()"
    ></ng-container>
  } @else {
  <!-- Default panel -->
  <div
    class="relative z-10 w-full max-w-xl overflow-hidden rounded-xl border border-neutral-200 bg-white shadow-2xl dark:border-neutral-700 dark:bg-neutral-900"
    role="dialog"
    aria-modal="true"
    aria-label="Command menu"
  >
    <!-- Header -->
    @if (headerTemplate(); as ht) {
      <ng-container
        [ngTemplateOutlet]="ht.template"
        [ngTemplateOutletContext]="getHeaderContext()"
      ></ng-container>
    } @else {
    <div class="flex items-center border-b border-neutral-200 px-4 dark:border-neutral-700">
      <svg
        class="h-5 w-5 text-neutral-400"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"
        />
      </svg>
      <input
        #searchInput
        type="text"
        [placeholder]="service.config().placeholder"
        [value]="query()"
        (input)="onQueryChange($event)"
        (keydown)="onInputKeydown($event)"
        class="flex-1 bg-transparent px-3 py-4 text-base text-neutral-900 placeholder-neutral-400 outline-none dark:text-neutral-100"
      />
      <kbd
        class="rounded border border-neutral-200 bg-neutral-100 px-1.5 py-0.5 text-xs text-neutral-500 dark:border-neutral-600 dark:bg-neutral-800 dark:text-neutral-400"
      >
        ESC
      </kbd>
    </div>
    }

    <!-- Items list -->
    <div #listContainer class="max-h-80 overflow-y-auto p-2">
      @if (filteredItems().length === 0) {
        <!-- Empty state -->
        @if (emptyTemplate(); as et) {
          <ng-container
            [ngTemplateOutlet]="et.template"
            [ngTemplateOutletContext]="getEmptyContext()"
          ></ng-container>
        } @else {
        <div class="px-3 py-8 text-center text-neutral-500">
          No results found
        </div>
        }
      } @else {
        @for (item of filteredItems(); track item.id; let i = $index) {
          <!-- Custom item template -->
          @if (itemTemplate(); as it) {
            <ng-container
              [ngTemplateOutlet]="it.template"
              [ngTemplateOutletContext]="getItemContext(item, i)"
            ></ng-container>
          } @else {
          <!-- Default item -->
          <button
            type="button"
            (click)="executeItem(item)"
            (mouseenter)="selectedIndex.set(i)"
            [attr.data-index]="i"
            [class]="
            'flex w-full items-center gap-3 rounded-lg px-3 py-2.5 text-left transition-colors ' +
            (selectedIndex() === i
            ? 'bg-neutral-100 dark:bg-neutral-800'
            : 'hover:bg-neutral-50 dark:hover:bg-neutral-800/50')
            "
          >
            @if (item.iconClass) {
            <i [class]="item.iconClass + ' text-lg text-neutral-600 dark:text-neutral-300'"></i>
            } @else if (item.icon) {
            <span class="text-lg">{{ item.icon }}</span>
            } @else {
            <span
              class="flex h-6 w-6 items-center justify-center rounded bg-neutral-200 text-xs font-medium text-neutral-600 dark:bg-neutral-700 dark:text-neutral-300"
            >
              {{ item.category === 'page' ? 'P' : 'C' }}
            </span>
            }
            <div class="flex-1 min-w-0">
              <div class="truncate font-medium text-neutral-900 dark:text-neutral-100">
                {{ item.label }}
              </div>
              @if (item.description) {
              <div class="truncate text-sm text-neutral-500 dark:text-neutral-400">
                {{ item.description }}
              </div>
              }
            </div>
            <span
              class="rounded-full px-2 py-0.5 text-xs"
              [class]="
              item.category === 'page'
              ? 'bg-blue-100 text-blue-700 dark:bg-blue-900/30 dark:text-blue-400'
              : 'bg-purple-100 text-purple-700 dark:bg-purple-900/30 dark:text-purple-400'
              "
            >
              {{ item.category }}
            </span>
          </button>
          }
        }
      }
    </div>

    <!-- Footer -->
    @if (footerTemplate(); as ft) {
      <ng-container
        [ngTemplateOutlet]="ft.template"
        [ngTemplateOutletContext]="getFooterContext()"
      ></ng-container>
    } @else {
    <div
      class="flex items-center justify-between border-t border-neutral-200 px-4 py-2 text-xs text-neutral-500 dark:border-neutral-700"
    >
      <div class="flex items-center gap-3">
        <span class="flex items-center gap-1">
          <kbd class="rounded border border-neutral-300 bg-neutral-100 px-1 dark:border-neutral-600 dark:bg-neutral-800">↑</kbd>
          <kbd class="rounded border border-neutral-300 bg-neutral-100 px-1 dark:border-neutral-600 dark:bg-neutral-800">↓</kbd>
          navigate
        </span>
        <span class="flex items-center gap-1">
          <kbd class="rounded border border-neutral-300 bg-neutral-100 px-1 dark:border-neutral-600 dark:bg-neutral-800">↵</kbd>
          select
        </span>
      </div>
      <span>gigamenu</span>
    </div>
    }
  </div>
  }
</div>
}
